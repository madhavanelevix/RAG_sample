# Django Backend: Campaign / Chats / Datas API

This document contains a full Django + Django REST Framework backend implementation for the PostgreSQL schema you requested. It includes project layout, settings snippets, models, serializers, viewsets, router configuration, migrations (including a migration to create the uuid-ossp extension), admin registrations, and example `requirements.txt` and `.env` guidance.

---

## Project layout

```
myproject/
├── manage.py
├── myproject/
│   ├── __init__.py
│   ├── settings.py
   ├── urls.py
│   └── wsgi.py
├── campaigns/            # Django app implementing your models + APIs
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations/
│   │   ├── __init__.py
│   │   └── 0001_initial.py   # autogenerated migration (we'll include code)
│   ├── models.py
│   ├── serializers.py
│   ├── views.py
│   ├── urls.py
│   └── tests.py
├── requirements.txt
└── README.md
```

---

## requirements.txt

```
django>=4.2
djangorestframework>=3.14
psycopg2-binary>=2.9
python-dotenv>=0.21.0
gunicorn>=20.1.0    # optional for deployment
```

---

## settings.py (important excerpts)

Add `rest_framework` and the app `campaigns` to `INSTALLED_APPS` and configure the database using environment variables.

```python
# myproject/settings.py (excerpt)
import os
from pathlib import Path
from dotenv import load_dotenv

load_dotenv()

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.getenv('SECRET_KEY', 'replace-me')
DEBUG = os.getenv('DEBUG', 'True') == 'True'
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', '*').split(',')

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    'rest_framework',
    'campaigns',
]

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv('POSTGRES_DB'),
        'USER': os.getenv('POSTGRES_USER'),
        'PASSWORD': os.getenv('POSTGRES_PASSWORD'),
        'HOST': os.getenv('POSTGRES_HOST', 'localhost'),
        'PORT': os.getenv('POSTGRES_PORT', '5432'),
    }
}

REST_FRAMEWORK = {
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
}

# Timezone
USE_TZ = True
TIME_ZONE = 'UTC'
```

Add a `.env` file in project root with keys `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_HOST`, `POSTGRES_PORT`, `SECRET_KEY`, etc.

---

## app: campaigns/models.py

```python
# campaigns/models.py
import uuid
from django.db import models

class Campaign(models.Model):
    class Status(models.TextChoices):
        PENDING = 'pending', 'Pending'
        PROCESSING = 'processing', 'Processing'
        STARTED = 'started', 'Started'
        COMPLETED = 'completed', 'Completed'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    title = models.TextField()
    description = models.TextField(blank=True)
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.PENDING)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.title} ({self.id})"


class Chat(models.Model):
    class Author(models.TextChoices):
        HUMAN = 'human', 'Human'
        AI = 'ai', 'AI'
        TOOL = 'tool', 'Tool'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    campaign = models.ForeignKey(Campaign, related_name='chats', on_delete=models.CASCADE)
    author = models.CharField(max_length=10, choices=Author.choices)
    message = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"Chat {self.id} ({self.author})"


class Data(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    context = models.TextField(blank=True)
    image = models.URLField(blank=True)
    chat = models.ForeignKey(Chat, related_name='datas', on_delete=models.CASCADE, null=True, blank=True)
    campaign = models.ForeignKey(Campaign, related_name='datas', on_delete=models.CASCADE, null=True, blank=True)

    def __str__(self):
        return f"Data {self.id}"
```

Notes:
- `auto_now_add` and `auto_now` provide automatic timestamp behaviour.
- `UUIDField` defaulting to `uuid.uuid4` gives UUID primary keys.
- Foreign keys cascade delete to match your schema.

---

## migrations: create `uuid-ossp` extension + initial models migration

Create `campaigns/migrations/0001_initial.py` with the migration code that also ensures the extension exists. Example migration snippet (Django migration file content):

```python
# campaigns/migrations/0001_initial.py
from django.db import migrations, models
import uuid
import django.db.models.deletion

class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.RunSQL("CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";", reverse_sql="DROP EXTENSION IF EXISTS \"uuid-ossp\";") ,

        migrations.CreateModel(
            name='Campaign',
            fields=[
                ('id', models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)),
                ('title', models.TextField()),
                ('description', models.TextField(blank=True)),
                ('status', models.CharField(max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='Chat',
            fields=[
                ('id', models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)),
                ('author', models.CharField(max_length=10)),
                ('message', models.TextField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('campaign', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='chats', to='campaigns.campaign')),
            ],
        ),
        migrations.CreateModel(
            name='Data',
            fields=[
                ('id', models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)),
                ('context', models.TextField(blank=True)),
                ('image', models.URLField(blank=True)),
                ('chat', models.ForeignKey(null=True, blank=True, related_name='datas', on_delete=django.db.models.deletion.CASCADE, to='campaigns.chat')),
                ('campaign', models.ForeignKey(null=True, blank=True, related_name='datas', on_delete=django.db.models.deletion.CASCADE, to='campaigns.campaign')),
            ],
        ),
    ]
```

Run `python manage.py makemigrations campaigns` and `python manage.py migrate` to apply.

---

## serializers.py

```python
# campaigns/serializers.py
from rest_framework import serializers
from .models import Campaign, Chat, Data

class DataSerializer(serializers.ModelSerializer):
    class Meta:
        model = Data
        fields = ['id', 'context', 'image', 'chat', 'campaign']


class ChatSerializer(serializers.ModelSerializer):
    datas = DataSerializer(many=True, read_only=True)

    class Meta:
        model = Chat
        fields = ['id', 'campaign', 'author', 'message', 'created_at', 'datas']
        read_only_fields = ['created_at', 'datas']


class CampaignSerializer(serializers.ModelSerializer):
    chats = ChatSerializer(many=True, read_only=True)
    datas = DataSerializer(many=True, read_only=True)

    class Meta:
        model = Campaign
        fields = ['id', 'title', 'description', 'status', 'created_at', 'updated_at', 'chats', 'datas']
        read_only_fields = ['created_at', 'updated_at', 'chats', 'datas']
```

Notes:
- Nested read-only relationships are included so API consumers can fetch related objects in one call.
- For heavy workloads you can remove nested serialization or create separate endpoints.

---

## views.py (viewsets)

```python
# campaigns/views.py
from rest_framework import viewsets, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import Campaign, Chat, Data
from .serializers import CampaignSerializer, ChatSerializer, DataSerializer


class CampaignViewSet(viewsets.ModelViewSet):
    queryset = Campaign.objects.all().order_by('-created_at')
    serializer_class = CampaignSerializer
    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['title', 'description', 'status']
    ordering_fields = ['created_at', 'updated_at', 'title']

    @action(detail=True, methods=['get'])
    def chats(self, request, pk=None):
        campaign = self.get_object()
        chats = campaign.chats.all()
        serializer = ChatSerializer(chats, many=True)
        return Response(serializer.data)


class ChatViewSet(viewsets.ModelViewSet):
    queryset = Chat.objects.all().order_by('created_at')
    serializer_class = ChatSerializer
    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['message', 'author']
    ordering_fields = ['created_at']


class DataViewSet(viewsets.ModelViewSet):
    queryset = Data.objects.all()
    serializer_class = DataSerializer
    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['context']
    ordering_fields = ['id']
```

---

## urls.py (project and app)

**project `myproject/urls.py`**

```python
# myproject/urls.py
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('campaigns.urls')),
]
```

**app `campaigns/urls.py`**

```python
# campaigns/urls.py
from rest_framework.routers import DefaultRouter
from .views import CampaignViewSet, ChatViewSet, DataViewSet
from django.urls import path, include

router = DefaultRouter()
router.register(r'campaigns', CampaignViewSet, basename='campaign')
router.register(r'chats', ChatViewSet, basename='chat')
router.register(r'datas', DataViewSet, basename='data')

urlpatterns = [
    path('', include(router.urls)),
]
```

This will expose endpoints like:
- `GET /api/campaigns/` (list)
- `POST /api/campaigns/` (create)
- `GET /api/campaigns/{id}/` (retrieve)
- `PATCH /api/campaigns/{id}/` (partial update)
- `DELETE /api/campaigns/{id}/` (delete)
- `GET /api/chats/`, `POST /api/chats/`, etc.

---

## admin.py

```python
# campaigns/admin.py
from django.contrib import admin
from .models import Campaign, Chat, Data

@admin.register(Campaign)
class CampaignAdmin(admin.ModelAdmin):
    list_display = ('id', 'title', 'status', 'created_at', 'updated_at')
    search_fields = ('title', 'description')
    list_filter = ('status',)


@admin.register(Chat)
class ChatAdmin(admin.ModelAdmin):
    list_display = ('id', 'campaign', 'author', 'created_at')
    search_fields = ('message', )
    list_filter = ('author',)


@admin.register(Data)
class DataAdmin(admin.ModelAdmin):
    list_display = ('id', 'campaign', 'chat', 'image')
    search_fields = ('context',)
```

---

## Example usage & commands

1. Create virtual env and install requirements

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2. Configure `.env` (example)

```
POSTGRES_DB=mydb
POSTGRES_USER=myuser
POSTGRES_PASSWORD=mypass
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
SECRET_KEY=replace-me
DEBUG=True
```

3. Run migrations

```bash
python manage.py makemigrations campaigns
python manage.py migrate
```

4. Create a superuser and run server

```bash
python manage.py createsuperuser
python manage.py runserver
```

5. Visit `http://127.0.0.1:8000/api/campaigns/` to interact with the API.

---

## Optional extras you might want next

- Add token authentication or JWT (djangorestframework-simplejwt).
- Add tests for endpoints (use `rest_framework.test.APIClient`).
- Add celery for background processing of campaigns.
- Add throttling / rate-limiting and permissions.
- Dockerize the app with a `Dockerfile` and `docker-compose` including Postgres.

---

If you'd like, I can now:
- generate the Dockerfile + docker-compose.yml
- provide the `manage.py` and complete `settings.py` file
- create example unit tests for the endpoints

Tell me which of those you'd like next and I'll add them into this repository structure.

